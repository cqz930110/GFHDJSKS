//
//  FriendSettingViewController.m
//  WeiPublicFund
//
//  Created by zhoupushan on 15/12/21.
//  Copyright © 2015年 www.niuduz.com. All rights reserved.
//

#import "FriendSettingViewController.h"
#import "FriendSetingMarkNameViewController.h"

@interface FriendSettingViewController ()
@property (weak, nonatomic) IBOutlet UISwitch *watchFriendSpaceSwitch;
@property (weak, nonatomic) IBOutlet UISwitch *watchMeSpaceSwitch;
@property (weak, nonatomic) IBOutlet UISwitch *blackSwitch;

@property (copy, nonatomic) NSString *notes;

@end

@implementation FriendSettingViewController

- (void)viewDidLoad
{
    [super viewDidLoad];
    self.title = @"资料设置";
    [self backBarItem];
}

#pragma mark - Actions
- (IBAction)settingName:(UIButton *)sender
{
    FriendSetingMarkNameViewController *vc = [[FriendSetingMarkNameViewController alloc]init];
    vc.notes = _notes;
    vc.username = _username;
    [self.navigationController pushViewController:vc animated:YES];
}

- (IBAction)valueChangeAction:(UISwitch *)sender
{
    [self requestSettingFreindWithSwitch:sender];
}

// 删除好友
- (IBAction)deleteFriend
{
    // 删除好友
    [self.httpUtil requestDic4MethodName:@"Friend/Delete" parameters:@{@"UserName":_username} result:^(NSDictionary *dic, int status, NSString *msg)
     {
         if (status == 1 ||  status == 2)
         {
             // 删除联系人
             EMError *error = nil;
             [[EaseMob sharedInstance].chatManager removeBuddy:_username removeFromRemote:YES error:&error];
             if (!error)
             {
                 [[EaseMob sharedInstance].chatManager removeConversationByChatter:_username deleteMessages:YES append2Chat:YES];
             }
             [self.navigationController popToRootViewControllerAnimated:YES];
         }
         else
         {
             [MBProgressHUD showError:msg toView:self.view];
         }
     }];
}

#pragma mark - Request
- (void)requestSettingFreindWithSwitch:(UISwitch *)switchView
{
    [MBProgressHUD showStatus:nil toView:self.view];
    [self.httpUtil requestDic4MethodName:@"Friend/Edit" parameters:@{@"StatusId":@(_blackSwitch.on),@"UserName":_username,@"INotSeeHimId":@(!_watchFriendSpaceSwitch.on),@"HeNotSeeMeId":@(!_watchMeSpaceSwitch.on)} result:^(NSDictionary *dic, int status, NSString *msg)
    {
        if (status == 1 || status == 2)
        {
            [MBProgressHUD dismissHUDForView:self.view];
            
            if (switchView.tag == 100)
            {
//                EMError *error = [[EaseMob sharedInstance].chatManager unblockBuddy:_username];
                if (_blackSwitch.on)
                {
                    [[EaseMob sharedInstance].chatManager asyncBlockBuddy:_username relationship:eRelationshipFrom];
                }
                else
                {
                    [[EaseMob sharedInstance].chatManager asyncUnblockBuddy:_username];
                }
            }
            
            [switchView setOn:switchView.on animated:YES];
        }
        else
        {
            [MBProgressHUD dismissHUDForView:self.view withError:msg];
        }
    }];
}

- (void)setUsername:(NSString *)username
{
    _username = username;
    [self.httpUtil requestDic4MethodName:@"Friend/GetSetting" parameters:@{@"UserName":_username} result:^(NSDictionary *dic, int status, NSString *msg)
     {
         NSLog(@"%@",dic);
         if (status == 1)
         {
             /// 备注与标签
             _notes = [dic valueForKey:@"Notes"];
             /// 是否不看他的动态，  0不看 1看   CommonStatus
             NSInteger commonStatus = [[dic valueForKey:@"INotSeeHimId"] integerValue];
             //         NSString *commonStatusStr = [NSString stringWithFormat:@"%d",commonStatus];
             BOOL watchFriend = commonStatus == 0?YES:NO;
             [_watchFriendSpaceSwitch setOn:watchFriend];
             
             
             /// 是否不让他看我的动态，0不看  1看  CommonStatus
             NSInteger heNotSeeStauts = [[dic valueForKey:@"HeNotSeeMeId"] integerValue];
             BOOL watchMeSpace = heNotSeeStauts == 0?YES:NO;
             [_watchMeSpaceSwitch setOn:watchMeSpace];
             
             
             /// 好友状态Id，  0 正常  1黑名单 2已删除
             NSInteger friendStatus = [[dic valueForKey:@"StatusId"] integerValue];
             BOOL blackStatus = friendStatus == 0?NO:YES;
             [_blackSwitch setOn:blackStatus];
         }
         else
         {
             [MBProgressHUD showError:msg toView:self.view];
         }
         
     }];
}

@end
